if(document.querySelector(".comment-barrage")){var commentBarrageConfig={maxBarrage:GLOBAL_CONFIG.commentBarrageConfig.maxBarrage,barrageTime:GLOBAL_CONFIG.commentBarrageConfig.barrageTime,twikooUrl:GLOBAL_CONFIG.twikooEnvId,accessToken:GLOBAL_CONFIG.commentBarrageConfig.accessToken,mailMd5:GLOBAL_CONFIG.commentBarrageConfig.mailMd5,pageUrl:window.location.pathname,barrageTimer:[],barrageList:[],barrageIndex:0,dom:document.querySelector(".comment-barrage")},commentInterval=null,hoverOnCommentBarrage=!1;function initCommentBarrage(){var e,a;commentBarrageConfig.dom&&(e=JSON.stringify({event:"COMMENT_GET","commentBarrageConfig.accessToken":commentBarrageConfig.accessToken,url:commentBarrageConfig.pageUrl}),(a=new XMLHttpRequest).withCredentials=!0,a.addEventListener("readystatechange",function(){4===this.readyState&&this.responseText&&(commentBarrageConfig.barrageList=commentLinkFilter(JSON.parse(this.responseText).data),commentBarrageConfig.dom.innerHTML="")}),a.open("POST",commentBarrageConfig.twikooUrl),a.setRequestHeader("Content-Type","application/json"),a.send(e),clearInterval(commentInterval),commentInterval=null,commentInterval=setInterval(()=>{commentBarrageConfig.barrageList.length&&!hoverOnCommentBarrage&&(popCommentBarrage(commentBarrageConfig.barrageList[commentBarrageConfig.barrageIndex]),commentBarrageConfig.barrageIndex+=1,commentBarrageConfig.barrageIndex%=commentBarrageConfig.barrageList.length),commentBarrageConfig.barrageTimer.length>(commentBarrageConfig.barrageList.length>commentBarrageConfig.maxBarrage?commentBarrageConfig.maxBarrage:commentBarrageConfig.barrageList.length)&&!hoverOnCommentBarrage&&removeCommentBarrage(commentBarrageConfig.barrageTimer.shift())},commentBarrageConfig.barrageTime))}function commentLinkFilter(e){e.sort((e,a)=>e.created-a.created);let a=[];return e.forEach(e=>{a.push(...getCommentReplies(e))}),a}function getCommentReplies(e){if(e.replies){let a=[e];return e.replies.forEach(e=>{a.push(...getCommentReplies(e))}),a}return[]}function popCommentBarrage(e){var a=document.createElement("div");a.className="comment-barrage-item",a.innerHTML=`
          <div class="barrageHead">
            <a class="barrageTitle ${e.mailMd5===commentBarrageConfig.mailMd5?"barrageBloggerTitle":""}" href="javascript:anzhiyu.scrollTo('#post-comment')"">
              ${e.mailMd5===commentBarrageConfig.mailMd5?"博主":"熱評"}
            </a>
            <div class="barrageNick">${e.nick}</div>
            <img class="nolazyload barrageAvatar" src="https://cravatar.cn/avatar/${e.mailMd5}"/>
            <a class="comment-barrage-close" href="javascript:anzhiyu.switchCommentBarrage()"><i class="anzhiyufont anzhiyu-icon-xmark"></i></a>
          </div>
          <anzhiyu class="barrageContent" onClick="window.location.hash = '${e.id}'">
            ${e.comment}
          </anzhiyu>
        `,a.querySelectorAll("anzhiyu pre").forEach(e=>{var a=document.createElement("span");a.innerText="【代碼】",e.parentNode.replaceChild(a,e)}),a.querySelectorAll("anzhiyu img").forEach(e=>{var a;e.classList.contains("tk-owo-emotion")||(e.style.display="none",(a=document.createElement("span")).innerText="【圖片】",e.parentNode.replaceChild(a,e))}),commentBarrageConfig.barrageTimer.push(a),commentBarrageConfig.dom.append(a)}function removeCommentBarrage(e){e.className="comment-barrage-item out",setTimeout(()=>{commentBarrageConfig.dom&&commentBarrageConfig.dom.contains(e)&&commentBarrageConfig.dom.removeChild(e)},1e3)}document.querySelector(".comment-barrage").addEventListener("mouseenter",function(){hoverOnCommentBarrage=!0}),document.querySelector(".comment-barrage").addEventListener("mouseleave",function(){hoverOnCommentBarrage=!1});let e=e=>{let a=document.querySelector(".comment-barrage"),r=document.getElementById("post-comment");e.forEach(e=>{r&&a&&768<document.body.clientWidth&&(a.style.bottom=e.isIntersecting?`-${200*commentBarrageConfig.maxBarrage}px`:"0")})},a=new IntersectionObserver(e,{root:null,rootMargin:"0px",threshold:0}),r=document.getElementById("post-comment");r&&a.observe(r),initCommentBarrage(),"false"!==localStorage.getItem("commentBarrageSwitch")?(document.querySelector(".comment-barrage").style.display="flex",document.querySelector(".menu-commentBarrage-text").textContent="關閉熱評"):(document.querySelector(".comment-barrage").style.display="none",document.querySelector(".menu-commentBarrage-text").textContent="顯示熱評"),document.addEventListener("pjax:send",function(){clearInterval(commentInterval)})}